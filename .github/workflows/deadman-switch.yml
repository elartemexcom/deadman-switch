name: Deadman Switch

on:
  workflow_dispatch:
  schedule:
    # Runs once per day at 07:00 UTC
    # (≈1–2 AM Texas depending on DST)
    - cron: "0 7 * * *"

permissions:
  contents: write

jobs:
  switch:
    runs-on: ubuntu-latest

    env:
      TZ: America/Chicago

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decide which index.html should be live
        shell: bash
        env:
          SECRET_INDEX_HTML: ${{ secrets.SECRET_INDEX_HTML }}
        run: |
          set -euo pipefail

          TODAY="$(date +%F)"
          CHECKIN=""

          if [[ -f checkin.txt ]]; then
            CHECKIN="$(tr -d '\r\n' < checkin.txt)"
          fi

          echo "Today (Texas): $TODAY"
          echo "Check-in date: ${CHECKIN:-<empty>}"

          if [[ "$CHECKIN" == "$TODAY" ]]; then
            echo "✅ Check-in current. Publishing placeholder."
            cp index.placeholder.html index.html
          else
            echo "⚠️ Check-in stale or missing. Publishing secret index."
            if [[ -z "${SECRET_INDEX_HTML:-}" ]]; then
              echo "ERROR: SECRET_INDEX_HTML is not set."
              exit 1
            fi
            printf "%s" "$SECRET_INDEX_HTML" > index.html
          fi

      - name: Commit and push if index.html changed
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Deadman switch update"
          git push
